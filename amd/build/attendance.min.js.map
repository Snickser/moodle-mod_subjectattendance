{"version":3,"file":"attendance.min.js","sources":["../src/attendance.js"],"sourcesContent":["// mod/subjectattendance/amd/src/attendance.js\ndefine(['jquery'], function($) {\n\n    /**\n     * Обновляет CSS-классы селекта в зависимости от значения.\n     * @param {HTMLElement} select - элемент select.\n     */\n    function updateClass(select) {\n        let val = $(select).val();\n        $(select).removeClass(\"present partial absent none\");\n        if (val === \"2\") {\n            $(select).addClass(\"present\");\n        } else if (val === \"1\") {\n            $(select).addClass(\"partial\");\n        } else if (val === \"0\") {\n            $(select).addClass(\"absent\");\n        } else {\n            $(select).addClass(\"none\");\n        }\n    }\n\n    /**\n     * Пересчитывает и обновляет сводку по строке таблицы.\n     * @param {HTMLElement} row - строка таблицы (tr).\n     */\n    function updateRowSummary(row) {\n        let present = 0, partial = 0, absent = 0;\n        $(row).find(\".attendance-select\").each(function() {\n            if ($(this).val() === \"2\") {\n                present++;\n            } else if ($(this).val() === \"1\") {\n                partial++;\n            } else if ($(this).val() === \"0\") {\n                absent++;\n            }\n        });\n        let $summary = $(row).find(\".attendance-summary\");\n        if (!$summary.length) {\n            return;\n        }\n        $summary.html(\n            (present ? \"<div style='flex: 1; background: #c8e6c9;'>\" + present + \"</div>\" : \"\") +\n            (partial ? \"<div style='flex: 1; background: #fff9c4;'>\" + partial + \"</div>\" : \"\") +\n            (absent ? \"<div style='flex: 1; background: #ffcdd2;'>\" + absent + \"</div>\" : \"\")\n        );\n    }\n\n    /**\n     * Инициализация обработчиков событий.\n     */\n    function init() {\n        $(\".attendance-select\").each(function() {\n            updateClass(this);\n\n            $(this).on(\"change\", function() {\n                updateClass(this);\n\n                let studentid = $(this).data(\"studentid\");\n                let subjectid = $(this).data(\"subjectid\");\n                let cmid = $(this).data(\"cmid\");\n                let attendanceid = $(this).data(\"attendanceid\");\n\n                fetch(M.cfg.wwwroot + \"/mod/subjectattendance/ajax_save.php\", {\n                    method: \"POST\",\n                    headers: {\n                        \"Content-Type\": \"application/json\",\n                        \"Accept\": \"application/json\"\n                    },\n                    body: JSON.stringify({\n                        sesskey: M.cfg.sesskey,\n                        studentid: studentid,\n                        subjectid: subjectid,\n                        cmid: cmid,\n                        attendanceid: attendanceid,\n                        status: $(this).val()\n                    })\n                })\n                .then(r => r.json())\n                .then(data => {\n                    if (!data.success) {\n                        alert(data.error);\n                    } else {\n                        updateRowSummary($(this).closest(\"tr\"));\n                    }\n                })\n                .catch(error => alert(error));\n            });\n        });\n    }\n\n    return { init: init };\n});\n"],"names":["define","$","updateClass","select","val","removeClass","addClass","init","each","this","on","studentid","data","subjectid","cmid","attendanceid","fetch","M","cfg","wwwroot","method","headers","body","JSON","stringify","sesskey","status","then","r","json","success","row","present","partial","absent","find","$summary","length","html","updateRowSummary","closest","alert","error","catch"],"mappings":"AACAA,0CAAO,CAAC,WAAW,SAASC,YAMfC,YAAYC,YACbC,IAAMH,EAAEE,QAAQC,MACpBH,EAAEE,QAAQE,YAAY,+BACV,MAARD,IACAH,EAAEE,QAAQG,SAAS,WACJ,MAARF,IACPH,EAAEE,QAAQG,SAAS,WACJ,MAARF,IACPH,EAAEE,QAAQG,SAAS,UAEnBL,EAAEE,QAAQG,SAAS,cAyEpB,CAAEC,gBAvCLN,EAAE,sBAAsBO,MAAK,WACzBN,YAAYO,MAEZR,EAAEQ,MAAMC,GAAG,UAAU,WACjBR,YAAYO,UAERE,UAAYV,EAAEQ,MAAMG,KAAK,aACzBC,UAAYZ,EAAEQ,MAAMG,KAAK,aACzBE,KAAOb,EAAEQ,MAAMG,KAAK,QACpBG,aAAed,EAAEQ,MAAMG,KAAK,gBAEhCI,MAAMC,EAAEC,IAAIC,QAAU,uCAAwC,CAC1DC,OAAQ,OACRC,QAAS,gBACW,0BACN,oBAEdC,KAAMC,KAAKC,UAAU,CACjBC,QAASR,EAAEC,IAAIO,QACfd,UAAWA,UACXE,UAAWA,UACXC,KAAMA,KACNC,aAAcA,aACdW,OAAQzB,EAAEQ,MAAML,UAGvBuB,MAAKC,GAAKA,EAAEC,SACZF,MAAKf,OACGA,KAAKkB,iBAtDAC,SAClBC,QAAU,EAAGC,QAAU,EAAGC,OAAS,EACvCjC,EAAE8B,KAAKI,KAAK,sBAAsB3B,MAAK,WACb,MAAlBP,EAAEQ,MAAML,MACR4B,UACyB,MAAlB/B,EAAEQ,MAAML,MACf6B,UACyB,MAAlBhC,EAAEQ,MAAML,OACf8B,gBAGJE,SAAWnC,EAAE8B,KAAKI,KAAK,uBACtBC,SAASC,QAGdD,SAASE,MACJN,QAAU,8CAAgDA,QAAU,SAAW,KAC/EC,QAAU,8CAAgDA,QAAU,SAAW,KAC/EC,OAAS,8CAAgDA,OAAS,SAAW,KAuClEK,CAAiBtC,EAAEQ,MAAM+B,QAAQ,OAFjCC,MAAM7B,KAAK8B,UAKlBC,OAAMD,OAASD,MAAMC"}